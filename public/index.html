<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Êï∞Áã¨ BATTLE</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&family=Bebas+Neue&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1a1a28;
  --border: #2a2a40;
  --accent: #00e5ff;
  --accent2: #ff3c6e;
  --accent3: #aaff00;
  --p1: #00e5ff;
  --p2: #ff9d00;
  --ai-color: #ff3c6e;
  --text: #e8e8f0;
  --text-dim: #6060a0;
  --grid-line: #2e2e48;
  --grid-bold: #5050a0;
  --fixed-bg: #1a1a35;
  --fixed-text: #ffffff;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'Noto Sans KR', sans-serif;
  min-height: 100vh; overflow-x: hidden;
}
body::before {
  content: ''; position: fixed; inset: 0;
  background-image: linear-gradient(rgba(0,229,255,0.025) 1px, transparent 1px), linear-gradient(90deg, rgba(0,229,255,0.025) 1px, transparent 1px);
  background-size: 44px 44px; pointer-events: none; z-index: 0;
}
.container { position: relative; z-index: 1; max-width: 960px; margin: 0 auto; padding: 12px 14px; }

/* HEADER */
header { text-align: center; padding: 14px 0 10px; }
.logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(2rem, 7vw, 4rem); letter-spacing: 0.12em; line-height: 1;
  background: linear-gradient(130deg, var(--accent) 20%, var(--accent2) 80%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.logo-sub { font-family: 'Space Mono', monospace; font-size: 0.58rem; letter-spacing: 0.4em; color: var(--text-dim); text-transform: uppercase; margin-top: 3px; }

/* SCREENS */
.screen { display: none; }
.screen.active { display: block; }

/* START SCREEN */
.start-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 26px 18px; text-align: center; margin-top: 10px; }
.start-card h2 { font-size: 0.72rem; font-weight: 700; color: var(--text-dim); letter-spacing: 0.25em; text-transform: uppercase; margin-bottom: 18px; }
.mode-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 9px; margin-bottom: 22px; }
.mode-btn { background: var(--surface2); border: 2px solid var(--border); border-radius: 10px; padding: 16px 12px; cursor: pointer; transition: all 0.18s; text-align: left; }
.mode-btn:hover { border-color: var(--accent); transform: translateY(-2px); }
.mode-btn.selected { border-color: var(--accent); background: rgba(0,229,255,0.07); }
.mode-btn .mode-icon { font-size: 1.6rem; margin-bottom: 6px; }
.mode-btn .mode-title { font-weight: 700; font-size: 0.88rem; color: var(--text); }
.mode-btn .mode-desc { font-size: 0.68rem; color: var(--text-dim); margin-top: 3px; line-height: 1.4; }
.mode-btn.pvp { border-color: rgba(255,157,0,0.35); }
.mode-btn.pvp:hover, .mode-btn.pvp.selected { border-color: var(--p2); background: rgba(255,157,0,0.07); }
.mode-btn.pvp .mode-title { color: var(--p2); }
.pvp-badge { display: inline-block; background: var(--p2); color: #000; font-family: 'Bebas Neue', sans-serif; font-size: 0.58rem; letter-spacing: 0.1em; padding: 1px 5px; border-radius: 3px; margin-left: 5px; vertical-align: middle; }
.diff-label { font-size: 0.7rem; color: var(--text-dim); letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 8px; }
.diff-btns { display: flex; gap: 7px; justify-content: center; margin-bottom: 22px; }
.diff-btn { background: var(--surface2); border: 2px solid var(--border); border-radius: 6px; padding: 7px 16px; cursor: pointer; font-family: 'Space Mono', monospace; font-size: 0.7rem; color: var(--text-dim); transition: all 0.18s; letter-spacing: 0.1em; }
.diff-btn:hover { border-color: var(--accent3); color: var(--accent3); }
.diff-btn.selected { border-color: var(--accent3); color: var(--accent3); background: rgba(170,255,0,0.07); }
.start-btn { background: linear-gradient(135deg, var(--accent), #009bbf); border: none; border-radius: 8px; padding: 12px 42px; font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 0.15em; color: var(--bg); cursor: pointer; transition: all 0.2s; }
.start-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,229,255,0.28); }

/* STATUS BAR */
.status-bar { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px; margin-bottom: 10px; }
.player-info { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 11px; }
.player-info.p1 { border-left: 3px solid var(--p1); }
.player-info.p2 { border-right: 3px solid var(--p2); text-align: right; }
.player-name { font-family: 'Space Mono', monospace; font-size: 0.58rem; letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 2px; }
.player-info.p1 .player-name { color: var(--p1); }
.player-info.p2 .player-name { color: var(--p2); }
.player-score { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 0.05em; line-height: 1; }
.player-info.p1 .player-score { color: var(--p1); }
.player-info.p2 .player-score { color: var(--p2); }
.player-progress { font-size: 0.62rem; color: var(--text-dim); margin-top: 2px; }
.timer-block { text-align: center; }
.timer-display { font-family: 'Space Mono', monospace; font-size: 1.4rem; color: var(--accent3); letter-spacing: 0.04em; }
.timer-label { font-size: 0.54rem; color: var(--text-dim); letter-spacing: 0.2em; text-transform: uppercase; margin-top: 2px; }
.ai-thinking { display: none; align-items: center; gap: 5px; justify-content: center; font-family: 'Space Mono', monospace; font-size: 0.58rem; color: var(--ai-color); letter-spacing: 0.1em; }
.ai-thinking.show { display: flex; }
.dot-pulse span { display: inline-block; width: 4px; height: 4px; background: var(--ai-color); border-radius: 50%; animation: dpulse 1.2s infinite; margin: 0 1px; }
.dot-pulse span:nth-child(2) { animation-delay: 0.2s; }
.dot-pulse span:nth-child(3) { animation-delay: 0.4s; }
@keyframes dpulse { 0%,80%,100%{transform:scale(0.6);opacity:0.4;} 40%{transform:scale(1);opacity:1;} }

/* PVP info bar */
.pvp-info-bar { display: none; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 7px 14px; text-align: center; margin-bottom: 9px; font-family: 'Space Mono', monospace; font-size: 0.62rem; letter-spacing: 0.08em; color: var(--text-dim); }
.pvp-info-bar.show { display: block; }
.pvp-info-bar .pi1 { color: var(--p1); }
.pvp-info-bar .pi2 { color: var(--p2); }

/* BATTLE AREA */
.battle-area { display: grid; grid-template-columns: 1fr; gap: 12px; }
@media (min-width: 600px) { .battle-area.two-boards { grid-template-columns: 1fr 1fr; } }

.board-wrapper { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 11px; }
.board-title { font-family: 'Space Mono', monospace; font-size: 0.6rem; letter-spacing: 0.24em; text-transform: uppercase; margin-bottom: 8px; padding-bottom: 7px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.board-wrapper.p1board .board-title { color: var(--p1); }
.board-wrapper.p2board .board-title { color: var(--p2); }
.board-wrapper.aiboard .board-title { color: var(--ai-color); }

/* GRID */
.sudoku-grid { display: grid; grid-template-columns: repeat(9,1fr); border: 2px solid var(--grid-bold); border-radius: 3px; overflow: hidden; width: 100%; aspect-ratio: 1; }
.cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: var(--bg); border: 1px solid var(--grid-line); font-family: 'Space Mono', monospace; font-size: clamp(0.85rem, 3vw, 1.4rem); font-weight: 700; cursor: pointer; transition: background 0.12s; color: #ffffff; user-select: none; -webkit-tap-highlight-color: transparent; }
.cell:nth-child(3n) { border-right: 2px solid var(--grid-bold); }
.cell:nth-child(9n) { border-right: 1px solid var(--grid-line); }
.cell[data-row="2"], .cell[data-row="5"] { border-bottom: 2px solid var(--grid-bold); }
.cell.fixed { background: var(--fixed-bg); color: #ffffff; cursor: default; font-weight: 900; text-shadow: 0 0 8px rgba(180,180,255,0.5); }
.cell.sel1 { background: rgba(0,229,255,0.16) !important; }
.cell.sel2 { background: rgba(255,157,0,0.18) !important; }
.cell.hl1 { background: rgba(0,229,255,0.05); }
.cell.hl2 { background: rgba(255,157,0,0.05); }
.cell.err { color: var(--accent2) !important; }
.cell.cf { animation: cflash 0.35s ease; }
@keyframes cflash { 0%{background:rgba(170,255,0,0.38);} 100%{background:transparent;} }
.cell.p2fill { color: var(--p2); text-shadow: 0 0 6px rgba(255,157,0,0.5); }
.cell.aifill { color: #ff6e96; text-shadow: 0 0 6px rgba(255,60,110,0.5); }
.cell.err { color: #ff4477 !important; text-shadow: 0 0 8px rgba(255,60,110,0.6) !important; }

/* NUMPAD */
.numpad { display: grid; grid-template-columns: repeat(9,1fr); gap: 3px; margin-top: 8px; }
.nbtn { aspect-ratio: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: #ffffff; font-family: 'Space Mono', monospace; font-size: clamp(0.75rem, 2.2vw, 1.1rem); font-weight: 700; cursor: pointer; transition: all 0.12s; display: flex; align-items: center; justify-content: center; }
.nbtn:hover { background: rgba(0,229,255,0.1); border-color: var(--accent); }
.nbtn:active { transform: scale(0.88); }
.nbtn.p2s:hover { background: rgba(255,157,0,0.1); border-color: var(--p2); }
.tool-row { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-top: 3px; }
.tbtn { background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; padding: 5px 4px; cursor: pointer; font-family: 'Space Mono', monospace; font-size: 0.58rem; letter-spacing: 0.04em; color: var(--text-dim); transition: all 0.12s; text-align: center; }
.tbtn:hover { border-color: var(--accent2); color: var(--accent2); }

/* PROGRESS */
.pw { margin-top: 7px; background: var(--border); border-radius: 2px; height: 3px; overflow: hidden; }
.pf { height: 100%; border-radius: 2px; transition: width 0.35s ease; }
.p1board .pf { background: var(--p1); }
.p2board .pf, .pvpboard2 .pf { background: var(--p2); }
.aiboard .pf { background: var(--ai-color); }

/* CONTROLS */
.controls { display: flex; gap: 7px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
.cbtn { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 6px 13px; font-family: 'Space Mono', monospace; font-size: 0.64rem; letter-spacing: 0.1em; color: var(--text-dim); cursor: pointer; transition: all 0.14s; text-transform: uppercase; }
.cbtn:hover { border-color: var(--accent); color: var(--accent); }
.cbtn.hint { border-color: rgba(170,255,0,0.3); color: var(--accent3); }
.cbtn.hint2 { border-color: rgba(255,157,0,0.3); color: var(--p2); }
.cbtn.quit { border-color: rgba(255,60,110,0.3); color: var(--accent2); }
.hcnt { font-family: 'Bebas Neue', sans-serif; font-size: 0.82rem; margin-left: 2px; }

/* RESULT */
.result-overlay { display: none; position: fixed; inset: 0; background: rgba(10,10,15,0.93); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.result-overlay.show { display: flex; }
.result-card { background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 32px 24px; text-align: center; max-width: 380px; width: 92%; animation: rIn 0.4s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes rIn { from{transform:scale(0.8);opacity:0;} to{transform:scale(1);opacity:1;} }
.rtitle { font-family: 'Bebas Neue', sans-serif; font-size: 2.8rem; letter-spacing: 0.1em; line-height: 1; margin-bottom: 5px; }
.rwin { color: var(--accent3); } .rp1 { color: var(--p1); } .rp2 { color: var(--p2); } .rlose { color: var(--accent2); }
.rsub { color: var(--text-dim); font-size: 0.8rem; margin-bottom: 18px; }
.rstats { background: var(--surface2); border-radius: 8px; padding: 13px; margin-bottom: 18px; display: grid; grid-template-columns: 1fr 1fr; gap: 9px; text-align: left; }
.stat-lbl { font-size: 0.58rem; color: var(--text-dim); letter-spacing: 0.13em; text-transform: uppercase; }
.stat-val { font-family: 'Space Mono', monospace; font-size: 0.96rem; color: var(--text); margin-top: 2px; }
.rbtns { display: flex; gap: 8px; justify-content: center; }
.rbtn { border-radius: 6px; padding: 9px 20px; font-family: 'Bebas Neue', sans-serif; font-size: 1.05rem; letter-spacing: 0.1em; cursor: pointer; border: none; transition: all 0.18s; }
.rbtn.primary { background: var(--accent); color: var(--bg); }
.rbtn.secondary { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border); }
.rbtn:hover { transform: translateY(-2px); }

/* COUNTDOWN */
.cd-overlay { display: none; position: fixed; inset: 0; background: rgba(10,10,15,0.88); z-index: 150; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
.cd-overlay.show { display: flex; }
.cd-num { font-family: 'Bebas Neue', sans-serif; font-size: 9rem; line-height: 1; animation: cdpop 0.85s ease; }
@keyframes cdpop { 0%{transform:scale(2.2);opacity:0;} 30%{transform:scale(1);opacity:1;} 80%{transform:scale(1);opacity:1;} 100%{transform:scale(0.7);opacity:0;} }
.cd-num.go { color: var(--accent3); } .cd-num.num { color: var(--text); }

/* NOTIF */
.notif { position: fixed; top: 16px; left: 50%; transform: translateX(-50%) translateY(-60px); background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 7px 16px; font-family: 'Space Mono', monospace; font-size: 0.7rem; letter-spacing: 0.1em; z-index: 200; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); pointer-events: none; white-space: nowrap; }
.notif.show { transform: translateX(-50%) translateY(0); }
.notif.success { border-color: var(--accent3); color: var(--accent3); }
.notif.error { border-color: var(--accent2); color: var(--accent2); }
.notif.info { border-color: var(--accent); color: var(--accent); }
.notif.p2n { border-color: var(--p2); color: var(--p2); }

@media (max-width: 420px) { .player-score { font-size: 1.2rem; } .timer-display { font-size: 1.2rem; } }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">Êï∞Áã¨ BATTLE</div>
    <div class="logo-sub">Sudoku ¬∑ Strategy ¬∑ Speed</div>
  </header>

  <!-- START -->
  <div id="startScreen" class="screen active">
    <div class="start-card">
      <h2>Í≤åÏûÑ Î™®Îìú ÏÑ†ÌÉù</h2>
      <div class="mode-grid">
        <div class="mode-btn selected" data-mode="solo" onclick="selectMode('solo',this)">
          <div class="mode-icon">‚è±</div>
          <div class="mode-title">ÏÜîÎ°ú ÌÉÄÏûÑÏñ¥ÌÉù</div>
          <div class="mode-desc">ÌòºÏûê ÎèÑÏ†Ñ, ÏµúÍ≥† Í∏∞Î°ù Í∞±Ïã†</div>
        </div>
        <div class="mode-btn pvp" data-mode="pvp" onclick="selectMode('pvp',this)">
          <div class="mode-icon">‚öîÔ∏è</div>
          <div class="mode-title">1 vs 1 ÎåÄÍ≤∞ <span class="pvp-badge">NEW</span></div>
          <div class="mode-desc">Í∞ôÏùÄ Í∏∞Í∏∞ÏóêÏÑú Îëê ÌîåÎ†àÏù¥Ïñ¥ ÎèôÏãú Í≤ΩÏüÅ</div>
        </div>
        <div class="mode-btn" data-mode="ai" onclick="selectMode('ai',this)">
          <div class="mode-icon">ü§ñ</div>
          <div class="mode-title">AI ÎåÄÏ†Ñ</div>
          <div class="mode-desc">Î¥áÍ≥º Í∞ôÏùÄ ÌçºÏ¶ê Ïã§ÏãúÍ∞Ñ Í≤ΩÏüÅ</div>
        </div>
        <div class="mode-btn" data-mode="coop" onclick="selectMode('coop',this)">
          <div class="mode-icon">ü§ù</div>
          <div class="mode-title">ÌòëÎ†• Î™®Îìú</div>
          <div class="mode-desc">Í∞ôÏùÄ Î≥¥ÎìúÎ•º Ìï®Íªò ÌÅ¥Î¶¨Ïñ¥</div>
        </div>
      </div>
      <div class="diff-label">ÎÇúÏù¥ÎèÑ</div>
      <div class="diff-btns">
        <div class="diff-btn selected" data-diff="easy" onclick="selectDiff('easy',this)">EASY</div>
        <div class="diff-btn" data-diff="medium" onclick="selectDiff('medium',this)">MEDIUM</div>
        <div class="diff-btn" data-diff="hard" onclick="selectDiff('hard',this)">HARD</div>
      </div>
      <button class="start-btn" onclick="startGame()">START GAME</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="gameScreen" class="screen">
    <div class="status-bar">
      <div class="player-info p1">
        <div class="player-name" id="p1Name">YOU</div>
        <div class="player-score" id="p1Score">0</div>
        <div class="player-progress" id="p1Prog">0 / ‚Äî</div>
      </div>
      <div class="timer-block">
        <div class="timer-display" id="timerDisp">00:00</div>
        <div class="timer-label">TIME</div>
        <div class="ai-thinking" id="aiThink">
          <div class="dot-pulse"><span></span><span></span><span></span></div>
          <span>AI</span>
        </div>
      </div>
      <div class="player-info p2">
        <div class="player-name" id="p2Name">‚Äî</div>
        <div class="player-score" id="p2Score">‚Äî</div>
        <div class="player-progress" id="p2Prog">‚Äî</div>
      </div>
    </div>

    <!-- PVP controls info -->
    <div class="pvp-info-bar" id="pvpInfoBar">
      <span class="pi1">P1: ÎßàÏö∞Ïä§ÌÅ¥Î¶≠ ÏÖÄ ÏÑ†ÌÉù ‚Üí Ïà´ÏûêÌÇ§(1~9) ÏûÖÎ†•</span>
      &nbsp;|&nbsp;
      <span class="pi2">P2: ÎßàÏö∞Ïä§ÌÅ¥Î¶≠ ÏÖÄ ÏÑ†ÌÉù ‚Üí Ïà´ÏûêÌå®Îìú(1~9) ÏûÖÎ†•</span>
    </div>

    <div class="battle-area" id="battleArea">
      <!-- P1 board -->
      <div class="board-wrapper p1board" id="p1BW">
        <div class="board-title">
          <span id="p1BTitle">‚ñ∂ YOUR BOARD</span>
          <span id="p1HBadge" style="font-size:0.56rem;color:var(--accent3)">HINT √ó3</span>
        </div>
        <div class="sudoku-grid" id="p1Grid"></div>
        <div class="pw"><div class="pf" id="p1PF" style="width:0%"></div></div>
        <div id="p1NumWrap">
          <div class="numpad" id="p1Pad"></div>
          <div class="tool-row">
            <button class="tbtn" onclick="eraseCell(1)">‚å´ ÏßÄÏö∞Í∏∞</button>
            <button class="tbtn" onclick="toggleNotes(1)" id="nb1">‚úè Î©îÎ™® OFF</button>
          </div>
        </div>
      </div>

      <!-- P2 / AI board -->
      <div class="board-wrapper p2board" id="p2BW" style="display:none">
        <div class="board-title">
          <span id="p2BTitle">‚óÄ P2</span>
          <span id="p2HBadge" style="font-size:0.56rem;color:var(--p2)">HINT √ó3</span>
        </div>
        <div class="sudoku-grid" id="p2Grid"></div>
        <div class="pw"><div class="pf" id="p2PF" style="width:0%"></div></div>
        <div id="p2NumWrap">
          <div class="numpad" id="p2Pad"></div>
          <div class="tool-row">
            <button class="tbtn" onclick="eraseCell(2)">‚å´ ÏßÄÏö∞Í∏∞</button>
            <button class="tbtn" onclick="toggleNotes(2)" id="nb2">‚úè Î©îÎ™® OFF</button>
          </div>
        </div>
      </div>
    </div>

    <div class="controls" id="ctrlBar"></div>
  </div>
</div>

<!-- Result -->
<div class="result-overlay" id="resultOv">
  <div class="result-card">
    <div class="rtitle" id="rTitle">WIN!</div>
    <div class="rsub" id="rSub"></div>
    <div class="rstats" id="rStats"></div>
    <div class="rbtns">
      <button class="rbtn primary" onclick="restartGame()">PLAY AGAIN</button>
      <button class="rbtn secondary" onclick="goHome()">HOME</button>
    </div>
  </div>
</div>

<!-- Countdown -->
<div class="cd-overlay" id="cdOv">
  <div class="cd-num num" id="cdNum">3</div>
</div>

<div class="notif" id="notif"></div>

<script>
// ============ SUDOKU ENGINE ============
function genFull(){const g=Array.from({length:9},()=>Array(9).fill(0));fill(g);return g;}
function fill(g){
  const ns=shuf([1,2,3,4,5,6,7,8,9]);
  for(let r=0;r<9;r++)for(let c=0;c<9;c++){
    if(g[r][c]===0){
      for(let n of ns){if(ok(g,r,c,n)){g[r][c]=n;if(fill(g))return true;g[r][c]=0;}}
      return false;
    }
  }
  return true;
}
function ok(g,r,c,n){
  for(let i=0;i<9;i++){
    if(g[r][i]===n||g[i][c]===n)return false;
    if(g[3*Math.floor(r/3)+Math.floor(i/3)][3*Math.floor(c/3)+(i%3)]===n)return false;
  }
  return true;
}
function shuf(a){for(let i=a.length-1;i>0;i--){const j=0|Math.random()*(i+1);[a[i],a[j]]=[a[j],a[i]];}return a;}
function mkPuzzle(sol,diff){
  const rm={easy:35,medium:46,hard:55}[diff]||40;
  const p=sol.map(r=>[...r]);let rd=0;
  for(let idx of shuf([...Array(81).keys()])){
    if(rd>=rm)break;
    const r=0|idx/9,c=idx%9,bk=p[r][c];p[r][c]=0;
    if(cntSol(p.map(x=>[...x]))===1)rd++;else p[r][c]=bk;
  }
  return p;
}
function cntSol(g,cnt={n:0}){
  for(let r=0;r<9;r++)for(let c=0;c<9;c++){
    if(g[r][c]===0){
      for(let n=1;n<=9;n++){if(ok(g,r,c,n)){g[r][c]=n;cntSol(g,cnt);g[r][c]=0;if(cnt.n>1)return cnt.n;}}
      return cnt.n;
    }
  }
  cnt.n++;return cnt.n;
}

// ============ STATE ============
const S={
  mode:'solo',diff:'easy',
  sol:null,puz:null,
  b1:null,n1:null,f1:0,s1:0,e1:0,h1:3,hu1:0,nm1:false,r1:-1,c1:-1,
  b2:null,n2:null,f2:0,s2:0,e2:0,h2:3,hu2:0,nm2:false,r2:-1,c2:-1,
  tot:0,tsec:0,tInt:null,aiInt:null,on:false,aiDly:3000
};
let sMode='solo',sDiff='easy';

function selectMode(m,el){sMode=m;document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('selected'));el.classList.add('selected');}
function selectDiff(d,el){sDiff=d;document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('selected'));el.classList.add('selected');}

// ============ START ============
function startGame(){
  Object.assign(S,{mode:sMode,diff:sDiff,f1:0,s1:0,e1:0,h1:3,hu1:0,nm1:false,r1:-1,c1:-1,f2:0,s2:0,e2:0,h2:3,hu2:0,nm2:false,r2:-1,c2:-1,tot:0,tsec:0,on:false});
  clearInterval(S.tInt);clearInterval(S.aiInt);
  S.sol=genFull();S.puz=mkPuzzle(S.sol,S.diff);
  S.b1=S.puz.map(r=>[...r]);S.b2=S.puz.map(r=>[...r]);
  S.n1=Array.from({length:9},()=>Array.from({length:9},()=>new Set()));
  S.n2=Array.from({length:9},()=>Array.from({length:9},()=>new Set()));
  S.tot=S.puz.flat().filter(v=>v===0).length;
  S.aiDly={easy:4800,medium:2600,hard:1400}[S.diff]||3000;
  setupUI();showScreen('gameScreen');
  countdown(()=>{S.on=true;startTimer();if(S.mode==='ai')startAI();});
}

function setupUI(){
  const p1bw=document.getElementById('p1BW'),p2bw=document.getElementById('p2BW');
  const ba=document.getElementById('battleArea'),ctrl=document.getElementById('ctrlBar');
  const pvpBar=document.getElementById('pvpInfoBar'),aiThink=document.getElementById('aiThink');
  p1bw.className='board-wrapper p1board';p2bw.className='board-wrapper p2board';
  pvpBar.classList.remove('show');aiThink.classList.remove('show');

  if(S.mode==='pvp'){
    ba.className='battle-area two-boards';p2bw.style.display='';
    pvpBar.classList.add('show');
    $('p1Name').textContent='P1';$('p2Name').textContent='P2';
    $('p1BTitle').textContent='‚ñ∂ P1 BOARD';$('p2BTitle').textContent='‚ñ∂ P2 BOARD';
    $('p2HBadge').style.display='';$('p2NumWrap').style.display='';
    $('p2Score').textContent='0';$('p2Prog').textContent='0 / '+S.tot;
    ctrl.innerHTML=`<button class="cbtn hint" onclick="useHint(1)">P1 ÌûåÌä∏<span class="hcnt" id="hc1">3</span></button><button class="cbtn hint2" onclick="useHint(2)">P2 ÌûåÌä∏<span class="hcnt" id="hc2">3</span></button><button class="cbtn quit" onclick="quitGame()">QUIT</button>`;
  } else if(S.mode==='ai'){
    ba.className='battle-area two-boards';p2bw.style.display='';
    p2bw.className='board-wrapper aiboard';
    aiThink.classList.add('show');
    $('p1Name').textContent='YOU';$('p2Name').textContent='AI';
    $('p1BTitle').textContent='‚ñ∂ YOUR BOARD';$('p2BTitle').textContent='‚óÄ AI';
    $('p2HBadge').style.display='none';$('p2NumWrap').style.display='none';
    $('p2Score').textContent='0';$('p2Prog').textContent='0 / '+S.tot;
    ctrl.innerHTML=`<button class="cbtn hint" onclick="useHint(1)">HINT<span class="hcnt" id="hc1">3</span></button><button class="cbtn" onclick="toggleNotes(1)" id="nb1">‚úè Î©îÎ™® OFF</button><button class="cbtn quit" onclick="quitGame()">QUIT</button>`;
  } else {
    ba.className='battle-area';p2bw.style.display='none';
    const lbl=S.mode==='coop'?'P1+P2 ÌòëÎ†•':'YOU';
    $('p1Name').textContent=lbl;$('p2Name').textContent='‚Äî';
    $('p1BTitle').textContent=S.mode==='coop'?'‚ñ∂ COOP BOARD':'‚ñ∂ YOUR BOARD';
    $('p2Score').textContent='‚Äî';$('p2Prog').textContent=S.mode==='coop'?'ÌòëÎ†• Î™®Îìú':'ÌÉÄÏûÑÏñ¥ÌÉù';
    ctrl.innerHTML=`<button class="cbtn hint" onclick="useHint(1)">HINT<span class="hcnt" id="hc1">3</span></button><button class="cbtn" onclick="toggleNotes(1)" id="nb1">‚úè Î©îÎ™® OFF</button><button class="cbtn quit" onclick="quitGame()">QUIT</button>`;
  }
  renderGrid(1);renderGrid(2);buildPad(1);buildPad(2);updateUI();
  $('p1HBadge').textContent='HINT √ó3';if($('p2HBadge'))$('p2HBadge').textContent='HINT √ó3';
}

function $(id){return document.getElementById(id);}

// ============ COUNTDOWN ============
function countdown(cb){
  const ov=$('cdOv'),el=$('cdNum');
  ov.classList.add('show');let n=3;el.textContent=n;el.className='cd-num num';
  function tick(){
    n--;
    if(n<=0){el.textContent='GO!';el.className='cd-num go';setTimeout(()=>{ov.classList.remove('show');cb();},750);}
    else{el.textContent=n;el.className='cd-num num';el.style.animation='none';el.offsetHeight;el.style.animation='';setTimeout(tick,900);}
  }
  setTimeout(tick,900);
}

// ============ RENDER ============
function renderGrid(p){
  const board=p===1?S.b1:S.b2, notes=p===1?S.n1:S.n2;
  const gid=p===1?'p1Grid':'p2Grid';
  const sr=p===1?S.r1:S.r2, sc=p===1?S.c1:S.c2;
  const grid=$(gid);if(!grid)return;grid.innerHTML='';
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      const cel=document.createElement('div');
      cel.className='cell';cel.dataset.r=r;cel.dataset.c=c;cel.dataset.row=r;
      const v=board[r][c];
      if(S.puz[r][c]!==0){cel.classList.add('fixed');cel.textContent=v;}
      else if(v!==0){
        cel.textContent=v;
        if(v!==S.sol[r][c])cel.classList.add('err');
        else if(p===2&&S.mode==='pvp')cel.classList.add('p2fill');
        else if(p===2&&S.mode==='ai')cel.classList.add('aifill');
      } else {
        const ns=notes[r][c];
        if(ns.size>0)cel.innerHTML=noteHTML(ns);
      }
      // highlight
      if(r===sr&&c===sc) cel.classList.add(p===1?'sel1':'sel2');
      else if(sr>=0&&(r===sr||c===sc||sb(r,c,sr,sc))) cel.classList.add(p===1?'hl1':'hl2');
      // click handler
      if(p===1||(p===2&&S.mode==='pvp')){const pp=p;cel.addEventListener('click',()=>selCell(pp,r,c));}
      grid.appendChild(cel);
    }
  }
}
function sb(r1,c1,r2,c2){return Math.floor(r1/3)===Math.floor(r2/3)&&Math.floor(c1/3)===Math.floor(c2/3);}
function noteHTML(ns){
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);width:100%;height:100%;font-size:clamp(4px,0.9vw,7px);color:#5555aa;line-height:1;padding:1px;">';
  for(let n=1;n<=9;n++)h+=`<span style="text-align:center">${ns.has(n)?n:''}</span>`;
  return h+'</div>';
}
function buildPad(p){
  const pad=$(p===1?'p1Pad':'p2Pad');if(!pad)return;pad.innerHTML='';
  for(let n=1;n<=9;n++){
    const b=document.createElement('button');b.className='nbtn'+(p===2?' p2s':'');b.textContent=n;
    const pp=p;b.addEventListener('click',()=>inputNum(pp,n));pad.appendChild(b);
  }
}

// ============ INTERACTION ============
function selCell(p,r,c){if(p===1){S.r1=r;S.c1=c;}else{S.r2=r;S.c2=c;}renderGrid(p);}

function inputNum(p,n){
  if(!S.on)return;
  const board=p===1?S.b1:S.b2, notes=p===1?S.n1:S.n2;
  const sr=p===1?S.r1:S.r2, sc=p===1?S.c1:S.c2;
  if(sr<0||S.puz[sr][sc]!==0)return;
  const nm=p===1?S.nm1:S.nm2;
  if(nm){if(board[sr][sc]!==0)return;const ns=notes[sr][sc];if(ns.has(n))ns.delete(n);else ns.add(n);renderGrid(p);return;}
  // toggle erase
  if(board[sr][sc]===n){board[sr][sc]=0;if(p===1)S.f1=Math.max(0,S.f1-1);else S.f2=Math.max(0,S.f2-1);updateUI();renderGrid(p);return;}
  notes[sr][sc].clear();
  const correct=n===S.sol[sr][sc];
  if(!correct){
    if(p===1){S.e1++;S.s1=Math.max(0,S.s1-20);showNotif('P1 Ïò§Îãµ! -20Ï†ê','error');}
    else{S.e2++;S.s2=Math.max(0,S.s2-20);showNotif('P2 Ïò§Îãµ! -20Ï†ê','p2n');}
  } else {
    const pts=Math.max(10,50-Math.floor(S.tsec/30)*5);
    if(p===1){S.f1++;S.s1+=pts;}else{S.f2++;S.s2+=pts;}
    flash(p,sr,sc);
  }
  board[sr][sc]=n;updateUI();renderGrid(p);
  if((p===1?S.f1:S.f2)===S.tot)endGame(p===1?'p1':'p2');
}

function flash(p,r,c){
  setTimeout(()=>{
    const el=document.querySelector(`#${p===1?'p1Grid':'p2Grid'} .cell[data-r="${r}"][data-c="${c}"]`);
    if(el){el.classList.add('cf');setTimeout(()=>el.classList.remove('cf'),350);}
  },10);
}

function eraseCell(p){
  if(!S.on)return;
  const board=p===1?S.b1:S.b2, notes=p===1?S.n1:S.n2;
  const r=p===1?S.r1:S.r2, c=p===1?S.c1:S.c2;
  if(r<0||S.puz[r][c]!==0)return;
  if(board[r][c]!==0&&board[r][c]===S.sol[r][c]){if(p===1)S.f1=Math.max(0,S.f1-1);else S.f2=Math.max(0,S.f2-1);}
  board[r][c]=0;notes[r][c].clear();updateUI();renderGrid(p);
}

function toggleNotes(p){
  if(p===1){S.nm1=!S.nm1;const b=$('nb1');if(b)b.textContent='‚úè Î©îÎ™® '+(S.nm1?'ON':'OFF');}
  else{S.nm2=!S.nm2;const b=$('nb2');if(b)b.textContent='‚úè Î©îÎ™® '+(S.nm2?'ON':'OFF');}
}

function useHint(p){
  if(!S.on)return;
  const hs=p===1?S.h1:S.h2;if(hs<=0){showNotif('ÌûåÌä∏ ÏóÜÏùå!','error');return;}
  const board=p===1?S.b1:S.b2, notes=p===1?S.n1:S.n2;
  const sr=p===1?S.r1:S.r2, sc=p===1?S.c1:S.c2;
  let t=null;
  if(sr>=0&&S.puz[sr][sc]===0&&board[sr][sc]===0)t=[sr,sc];
  else{const em=[];for(let r=0;r<9;r++)for(let c=0;c<9;c++)if(S.puz[r][c]===0&&board[r][c]===0)em.push([r,c]);if(em.length)t=em[0|Math.random()*em.length];}
  if(!t){showNotif('ÌûåÌä∏ ÏóÜÏùå','info');return;}
  const[r,c]=t;board[r][c]=S.sol[r][c];notes[r][c].clear();
  if(p===1){S.f1++;S.h1--;S.hu1++;S.s1=Math.max(0,S.s1-50);}
  else{S.f2++;S.h2--;S.hu2++;S.s2=Math.max(0,S.s2-50);}
  const hc=$(p===1?'hc1':'hc2');if(hc)hc.textContent=p===1?S.h1:S.h2;
  const hb=$(p===1?'p1HBadge':'p2HBadge');if(hb)hb.textContent='HINT √ó'+(p===1?S.h1:S.h2);
  showNotif(`P${p} ÌûåÌä∏ ÏÇ¨Ïö© (-50Ï†ê)`,p===1?'info':'p2n');
  renderGrid(p);updateUI();
  if((p===1?S.f1:S.f2)===S.tot)endGame(p===1?'p1':'p2');
}

// ============ KEYBOARD ============
document.addEventListener('keydown',e=>{
  if(!S.on)return;
  if(['INPUT','BUTTON','TEXTAREA'].includes(e.target.tagName))return;
  if(S.mode==='pvp'){
    // P1: number row 1-9, arrows
    if(e.key>='1'&&e.key<='9'&&!e.code.startsWith('Numpad')){inputNum(1,+e.key);return;}
    if((e.key==='Backspace'||e.key==='Delete')&&!e.code.startsWith('Numpad')){eraseCell(1);return;}
    const mv={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1]};
    if(mv[e.key]){e.preventDefault();let nr=S.r1+mv[e.key][0],nc=S.c1+mv[e.key][1];if(nr>=0&&nr<9&&nc>=0&&nc<9){S.r1=nr;S.c1=nc;renderGrid(1);}return;}
    // P2: numpad keys, WASD move
    const npm={'Numpad1':1,'Numpad2':2,'Numpad3':3,'Numpad4':4,'Numpad5':5,'Numpad6':6,'Numpad7':7,'Numpad8':8,'Numpad9':9};
    if(npm[e.code]){inputNum(2,npm[e.code]);return;}
    if(e.code==='Numpad0'||e.code==='NumpadDecimal'){eraseCell(2);return;}
    const mv2={KeyW:[-1,0],KeyS:[1,0],KeyA:[0,-1],KeyD:[0,1]};
    if(mv2[e.code]){e.preventDefault();let nr=S.r2+mv2[e.code][0],nc=S.c2+mv2[e.code][1];if(nr>=0&&nr<9&&nc>=0&&nc<9){S.r2=nr;S.c2=nc;renderGrid(2);}return;}
    return;
  }
  // solo / ai / coop
  if(e.key>='1'&&e.key<='9'){inputNum(1,+e.key);return;}
  if(e.key==='Backspace'||e.key==='Delete'||e.key==='0'){eraseCell(1);return;}
  const mv={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1]};
  if(mv[e.key]){e.preventDefault();let nr=S.r1+mv[e.key][0],nc=S.c1+mv[e.key][1];if(nr>=0&&nr<9&&nc>=0&&nc<9){S.r1=nr;S.c1=nc;renderGrid(1);}}
});

// ============ TIMER ============
function startTimer(){
  clearInterval(S.tInt);
  S.tInt=setInterval(()=>{if(!S.on)return;S.tsec++;const m=String(0|S.tsec/60).padStart(2,'0'),s=String(S.tsec%60).padStart(2,'0');$('timerDisp').textContent=`${m}:${s}`;},1000);
}

// ============ AI ============
function startAI(){
  if(S.mode!=='ai')return;
  clearInterval(S.aiInt);
  const cells=shuf([...Array(81).keys()].filter(i=>S.puz[0|i/9][i%9]===0).map(i=>[0|i/9,i%9]));
  let idx=0;
  S.aiInt=setInterval(()=>{
    if(!S.on||idx>=cells.length){clearInterval(S.aiInt);return;}
    const[r,c]=cells[idx++];
    S.b2[r][c]=S.sol[r][c];S.f2++;S.s2+=40;
    const el=document.querySelector(`#p2Grid .cell[data-r="${r}"][data-c="${c}"]`);
    if(el){el.classList.add('aifill');el.textContent=S.b2[r][c];}
    updateUI();if(S.f2===S.tot)endGame('p2');
  },S.aiDly);
}

// ============ UI ============
function updateUI(){
  $('p1Score').textContent=S.s1;$('p1Prog').textContent=`${S.f1} / ${S.tot}`;$('p1PF').style.width=`${(S.f1/S.tot)*100}%`;
  if(S.mode==='ai'||S.mode==='pvp'){
    $('p2Score').textContent=S.s2;$('p2Prog').textContent=`${S.f2} / ${S.tot}`;$('p2PF').style.width=`${(S.f2/S.tot)*100}%`;
  }
}

// ============ END ============
function endGame(winner){
  S.on=false;clearInterval(S.tInt);clearInterval(S.aiInt);
  const m=String(0|S.tsec/60).padStart(2,'0'),s=String(S.tsec%60).padStart(2,'0');
  const t=$('rTitle'),sb=$('rSub'),st=$('rStats');
  if(S.mode==='pvp'){
    if(winner==='p1'){t.textContent='P1 WIN!';t.className='rtitle rp1';sb.textContent='P1Ïù¥ Î®ºÏ†Ä ÏôÑÏÑ±! üéâ';}
    else{t.textContent='P2 WIN!';t.className='rtitle rp2';sb.textContent='P2Í∞Ä Î®ºÏ†Ä ÏôÑÏÑ±! üéâ';}
    st.innerHTML=`
      <div><div class="stat-lbl">Time</div><div class="stat-val">${m}:${s}</div></div>
      <div><div class="stat-lbl">P1 Score</div><div class="stat-val" style="color:var(--p1)">${S.s1}</div></div>
      <div><div class="stat-lbl">P1 Errors</div><div class="stat-val">${S.e1}</div></div>
      <div><div class="stat-lbl">P2 Score</div><div class="stat-val" style="color:var(--p2)">${S.s2}</div></div>
      <div><div class="stat-lbl">P2 Errors</div><div class="stat-val">${S.e2}</div></div>
      <div><div class="stat-lbl">P1 Hints</div><div class="stat-val">${S.hu1}</div></div>`;
  } else if(S.mode==='ai'){
    if(winner==='p1'){t.textContent='WIN!';t.className='rtitle rwin';sb.textContent='AIÎ•º Ïù¥Í≤ºÏäµÎãàÎã§! üéâ';}
    else{t.textContent='LOSE';t.className='rtitle rlose';sb.textContent='AIÍ∞Ä Î®ºÏ†Ä ÌíÄÏóàÏäµÎãàÎã§. Îã§Ïãú ÎèÑÏ†Ñ!';}
    st.innerHTML=`<div><div class="stat-lbl">Time</div><div class="stat-val">${m}:${s}</div></div><div><div class="stat-lbl">Score</div><div class="stat-val">${S.s1}</div></div><div><div class="stat-lbl">Errors</div><div class="stat-val">${S.e1}</div></div><div><div class="stat-lbl">Hints</div><div class="stat-val">${S.hu1}</div></div>`;
  } else {
    t.textContent='CLEAR!';t.className='rtitle rwin';sb.textContent='ÏôÑÎ£å! ÏàòÍ≥†ÌïòÏÖ®ÏäµÎãàÎã§ üéâ';
    st.innerHTML=`<div><div class="stat-lbl">Time</div><div class="stat-val">${m}:${s}</div></div><div><div class="stat-lbl">Score</div><div class="stat-val">${S.s1}</div></div><div><div class="stat-lbl">Errors</div><div class="stat-val">${S.e1}</div></div><div><div class="stat-lbl">Hints</div><div class="stat-val">${S.hu1}</div></div>`;
  }
  $('resultOv').classList.add('show');
}

function quitGame(){S.on=false;clearInterval(S.tInt);clearInterval(S.aiInt);goHome();}
function restartGame(){$('resultOv').classList.remove('show');startGame();}
function goHome(){S.on=false;clearInterval(S.tInt);clearInterval(S.aiInt);$('resultOv').classList.remove('show');showScreen('startScreen');}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$(id).classList.add('active');}

let ntT=null;
function showNotif(msg,type='info'){const el=$('notif');el.textContent=msg;el.className=`notif ${type} show`;clearTimeout(ntT);ntT=setTimeout(()=>el.classList.remove('show'),2000);}
</script>
</body>
</html>
